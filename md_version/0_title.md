# GNU Awk
#### GAWK： awk 完全参考手册
#### GNU awk 4.1 版用户指南
#### 2015年4月

&nbsp;
___
献给我的父母，谢谢他们给我的爱，以及为我树立起的榜样。

献给我的妻子，Miriam，他使我有一个完整的人生。谢谢你让我一起建设你的生活。

献给我的孩子们，Chana，Rivka，Nachum，以及 Malka，因为你们而使得我们的生活丰富多彩。

&nbsp;
## 第三版前言

&emsp;&emsp;我跟 Arnold Robbins 是好朋友。我们由于 AWK 因缘际会而结识。这是好几年前的事了。当时我正开始一份新工作，并注意到在公司角落里放着一台没用的 Unix 计算机。没有人知道怎么使用它，我也不会。但是，几天后，它跑起来了，并且我就是 root，也是唯一的用户。从那天起，我就开始从一个统计分析师向一个 Unix 程序员转变了。

&emsp;&emsp;我经常往返于图书馆与书店，搜索跟 Unix 相关的图书。有一次找到一本灰色的 AWK 相关的书，即 a.k.a. Alfred V. Aho， Brian W. Kernighan， 与 Peter J. Weinberger 写的 The AWK Programming Language (Addison-Wesley， 1988)。awk 简洁的编程规范——就是在输入中查找某种模式的字串并执行相应动作——经常能够将复杂的或者冗长的操作化为几行代码。我非常兴奋，并着手开始利用 AWK 进行编程。

&emsp;&emsp;可是，我计算机上的 awk 是在灰色书里所描述的一个受限的语言版本。而我发现我的计算机中的就是“旧 awk”，而书中讲述的是“新 awk”。我知道这是典型情况；旧版本不肯让位，也不愿意放弃自己的名字。如果一个系统有一个“新 awk”，就会毫无例外地叫做 nawk，并且有几个系统有这样的软件。取得 nawk 的方式是通过 prep.ai.mit.edu 的 ftp 下载源代码。gawk 是一个由 David Trueman and Arnold 所写的新版本的 awk，并可以在 GNUL General Public License 的许可下取得。

&emsp;&emsp;（顺便说一句，现在找“新 awk”很容易了，GNU/Linux 就带有，你也可以在大多数系统中下载二进制版本或者源代码；我老婆就在他的 VMS BOX 中使用 gawk。）

&emsp;&emsp;我的 Unix 系统因闲置而被使用起来，当然也还不会连接到网络中。因此，很明显由于gawk 的存在，以及 Unix 社会社区的一般特点，我需要一个“新 awk”，因此，我就写了一个，我把它叫做 mawk。在我完成前，我已经知道了 gawk，但是已经太迟了。因此，我还是把 mawk 发送到了 comp.source 的新闻组里。

&emsp;&emsp;几天后，我收到了来自 Arnold 的邮件，里面他介绍了一下他自己。他建议我分享 mawk 的设计与算法，并且提交一个 POSIX 标准草案，这样我就能够更新 mawk 来支持 AWK Programming Language 发布后的语言扩展。

&emsp;&emsp;袒白讲，如果我们的角色互换，我可能就不会如此开放，我们也就可能从不会见面。我很高兴我们见了一面。他是一个 AWK 专家中的专家，也是确实是个好人。Arnold 为 Free Software Foundation 贡献了很多的才能与时间。

&emsp;&emsp;这本书是 gawk 的参考书，但是核心是一个关于 AWK 编程的书，适用于非常广的读者。编程规范参考的是 1987 年贝尔实验室的定义，并于1992年成为 POSIX 工具标准的语言规范。

&emsp;&emsp;另一方面，对于 AWK 程序新手，能够学到实用的编程方法，而这也正是 AWK 的基本方法：数据驱动控制流，利用正则表达式进行匹配，以及关联数组。那些正在尝鲜的人可以通过特殊的 /inet 文件来使用 gawk 的网络协议接口。

&emsp;&emsp;这本书中的例子会清楚地表明，使用 AWK 编写的程序要比C写成的程序更小更快。结果，可能利用 AWK 来编写算法并快速运行，以此来及时发现问题。经常的情况下，解释型的性能就足够了，因此 AWK 的原型就直接转换成了产品。

&emsp;&emsp;新的 pgawk（profiling gawk）会产生代码执行的采样数据。我最近实验了一个算法，即对 n 行输入，显示出约Cn2这样的性能，而理论预测下为约 Cnlogn。查看了 awkprof.out 程序几分钟后，就在程序的一行代码中发现了问题所在。这样，pgawk 又成为我程序员工具箱中的一个好工具。

&emsp;&emsp;Arnold 淫浸在 AWK 中有十几年，并且开发了 gawk，也即本书的主题。如果你使用 AWK，并且想知道 how，那么就读这本书吧。

<p align="right">Michael Brennan</p>

<p align="right">Author of mawk</p>

<p align="right">March 2001</p>

&nbsp;
## 第四版前言

&emsp;&emsp;有些东西一直没有变化。13年前，我写下“如果你使用 AWK 或者想学习它如何工作，那么就读这本书。”这句话当时是真理，而现在依然是真理。

&emsp;&emsp;学习如何使用编程语言并仅仅是掌握语法这么简单。需要在理解的基础上利用语言提供的特性来解决现实中的编程问题。这本书的焦点就是用许多的例子来展示如何使用 AWK。

&emsp;&emsp;而有些东西是有变化的。我们的计算机要比之前快得多，并且有更多的内存。结果是高级的语言导致了速度与存储的低效使用。因为性能而先在 AWK 中写原型然后用 C 重写，这种情况很少发生，因为更多的情况下，原型已经足够快了。

&emsp;&emsp;当然，有些操作更适合于用 C 或者 C++ 来实现，对于 gawk 4.1 以及后面的版本，你不需要选择到底是用 AWK 还是用 C/C++ 来实现。你可以用 AWK 来实现大部分的程序。而用 C/C++ 来写的程序，你完全可以用 C 或者 C++ 来写成动态插件，然后使用 gawk 进行装载合并。第十六章描述了所有的技术细节，其中有许多的例子，希望让你学习到里里外外的一切。

&emsp;&emsp;我很享受用 AWK 来进行编程，并且在用心（重）读这本书。我想你也会这样。

<p align="right">Michael Brennan</p>
<p align="right">Author of mawk</p>
<p align="right">October 2014</p>

&nbsp;
## 序言

&emsp;&emsp;当工作于文本文件的时候，有几类工作不断重复出现。你可能想抽取指定的行并丢弃其他部分。或者你想更改特定模式的文本，而其他部分的不变。这样的工作使用awk来完成通常很简单。awk工具解释特定的编程语言，使得它处理数据重组的工作非常在行。

&emsp;&emsp;GNU 版本的 awk 称为 gawk，使用恰当的参数或者环境变量，它完全与 POSIX 标准的，由 Brian Kemighan 维护的 Unix 版本的 awk 语言兼容。这就是说，正确编写的 awk 程序，也可以在 gawk 下运行。因此，在大多情况下，我们不区别两者的实现。

&emsp;&emsp;通过 awk 我们可以达到如下目的：

* 管理小的个人数据库
* 产生报表
* 完善数据
* 产生索引并执行其他文件准备工作
* 实验算法，这样可以回头用其他的语言实现。

&emsp;&emsp;除此之外，gawk 还提供如下设施，使我们能够：

* 抽取数据的位或者块用于处理
* 排序数据
* 测评并调试 awk 程序
* 用 C/C++ 编写函数以扩展语言功能 

&emsp;&emsp;本书会向你们传授awk语言，并告诉你们如何来有效地使用它。你有可能已经熟悉基本的系统命令，如 cat、ls[1] 等，也熟悉一些基本的 shell 工具，如输入输出重定向以及管道。

&emsp;&emsp;awk 语言的实现可以在许多不同的计算机环境中获取。本书除了描述 awk 语言的总体，也会描述awk 的特殊实现，即 gawk（表示 GNU awk）。gawk 在很多 Unix 系统下运行，包括从 Intel 架构的 PC 机，到大型机系统。gawk 也被移植到了 Mac OS 平台，Windows 平台（所有版本）以及 OS/2 的 PC 机，还有 OpenVMS[2]  系统上。 

&nbsp;

    注释:
    1. 这些工具在Posix 兼容的系统上都有，在传统的基于Unix 的系统上也存在。如果你使用的是一些其他的系统，你也需要熟悉一些IO重定向及管道的概念。
    2. 一些已经不用的系统，在这些系统上gawk 有过移植，但是已经不再支持，并且为支持这些系统而存在的代码也已经移除。

&nbsp;
## 译序

&emsp;&emsp;这是我第一次翻译这么长的书。

&emsp;&emsp;当我看到 GAWK 简单的语言与强大的功能时，我于是想到网上查找一些中文的资料，以快速学习一下这个工具，这样可以方便我在处理 Linux 字串时能够使用到它。

&emsp;&emsp;但是我很失望，找了很久，能够找到的资料基本上是支离破碎的，并没有完整全面的中文手册。我于是求其次地找了一个英文文档，其原名为《GAWK: Effective AWK Programming》，由 Arnold D. Robbins，即 gawk 当前的主要维护者之一编写。初看之下，里面的内容浅显易懂，正好符合我自己的需求。因为这个原因，我萌发了将这个手册翻译为中文的想法。但是我拿不准我是否有这样的坚持，能够将这个手册全部翻译出来。

&emsp;&emsp;我长久都没有动手，主要是因为没有这个魄力下定决心来做这件事情，再一个对于自己的语言能力也不太自信。一年后，这个想法一直在大脑里挥之不去。于是心里盘算，英文文档大概有500多页，如果我每天翻译两页，则一年后，怎么着也能够把这个文档翻译出来。并且，如果能够翻译到四页，则所需要的时间立即减少一半。翻译一本英文书，除去能力外，还得看自己是不是能够放弃翻译时的功利想法，觉得这么做是否值得。并在这种情况下，是否能够坚持一个较长而无味的过程，最后将文档翻译出来。最后，我还是下定决心，试一试。

&emsp;&emsp;于是我第一步是将 PDF 格式的英文文档转换成 Word 文档（我用其他的工具转换过，但是结果不是很好。因为原来的 PDF 文档中有很多特别的格式，在 Word 中很难控制。所以一不做，二不休，干脆把文字复制出来，再调整其格式与原来的 PDF 相符。我不知道这么做是不是很蠢，并有违程序员懒的美名！）。光这个事情就耗了我近一个星期的时间，2016 年春节前把这个底本做好了，并且开始了翻译。

&emsp;&emsp;实在的，前面的翻译速度是有一点慢，但是总体来说，还是按照原先的设计速度进行的。就算在过年的几天里，几乎每天都有进展。而且，翻译的难度不是很大，最考验人的是每天要拿出一定的时间来做这个事情。因为一旦停下来，就会为停下来找理由。后面就会有越来越多的理由来为延迟开脱。所以，自从翻译开始，我几乎没有中断每天做一点翻译。在翻译最后的几个附录中，我还差点要放弃翻译下去，因为觉得那些东西翻译没有什么用。但是为了保证翻译的完整性，同时也为把这个事情做“圆满”，我还是坚持把这个事情做下来了。最后只剩下 GPL 与 FDL 没有翻译。这两个协议比较其他的部分有难度一些。关键在于要翻译出带点协议性质，语言精准而且严谨，确实对我而言，能力还是不够的。而且这两个协议，我想在互联网上应该已经有了，所以也就不再翻译了。

&emsp;&emsp;翻译到后面的时候，自己确实感觉比原来快了，可能是因为熟练了的原因。剩下的整理也花掉了我的一些时间。通过翻译这个事情，确实使自己有如下收获：

1. 至少对 Word 文档的操作有一点点提升。
2. 考验并提升了一下自己的能力。
3. 再遇到长的英文文档，可能就没那么怵了。
4. 翻译能力是否有大的提高，这个不好说，但是应该有一点吧。

&emsp;&emsp;这里的文字，几乎都是一个字一个字码起来，而且也是第一次翻译，里面肯定还是有很多错误的地方，也有一些词不达意的地方，对于汉语的掌握有欠火候，也会使得翻译出来的行文没有那么符合中文习惯，或者不够优美。这些真还得要各位海涵，如果大家觉得这个翻译对大家有一点作用，我就觉得这些付出也值得了。如果读者更慷慨一点，能够告诉我哪里有问题，或者有一些改进的建议那就更好了。如果有这方面的改进，请发邮件到 yeyouqun@163.com。

&emsp;&emsp;我希望我的一点小努力，也为中国的软件事业做了一点点贡献。

&emsp;&emsp;在最后，如果要有什么感谢的，首先得要感谢自由软件运动的发起者们。如果没有他们，就不会有自由软件社区，也就不会有 GNU/Linux，也就没有 GAWK 这些优秀的工具。其次还要感谢原文的作者。别人也是自由软件的拥趸，如果没有他们的先期付出，也就没有这个文档的存在。目前还只有我一个人在翻译这个文档，如果可以，我想小激动地感谢一下自己。我希望以后感谢列表能够变得更长。希望更多的人参与到完善它的过程里来。

&emsp;&emsp;对了，我想感谢一下我儿子。好多次我打开电脑开启一天的翻译工作的时候，他经常会在键盘上随意敲击，使得我还得花掉一些时间来撤销他所做的“工作”。而且还要嚷着要听 《ABCD 歌》什么的，还得陪他听他所说的一万分钟那么久。

<p align="right">不自量力的叶佑群</p>
<p align="right">2016年 4 月 </p>
